# Deployment Guide

Topaz is most easily deployed as a container, either as a sidecar or as a microservice in the same region / AZ as the application it supports.

For environments that don't support running container images, Topaz can be run as a binary.

## Deploy as a Sidecar

Deploying topaz as a sidecar next to your applications is the most efficient way to use the authorizer as it minimizez the authorization latency.

In this section we can follow an example deployment on minikube based on a golang backend application and topaz authorizer as a sidecar.

Start by preparing minikube, you can follow the installation instructions [here](https://minikube.sigs.k8s.io/docs/start/).

Check if your minikube cluster is running:
```
minikube status

minikube
type: Control Plane
host: Running
kubelet: Running
apiserver: Running
kubeconfig: Configured
```
#### Preparing our backend application container.
1. Clone [todo-go-v2](https://github.com/aserto-demo/todo-go-v2) repository 
2. Add the following docker file to the root of your repository

Dockerfile:
```
FROM golang:1.19-alpine AS build-dev
RUN apk add --no-cache bash gcc build-base
WORKDIR /src

ENV GOBIN=/bin
ENV ROOT_DIR=/src

COPY . .
RUN go build

FROM alpine

LABEL org.opencontainers.image.title="todo-go-v2"
LABEL org.opencontainers.image.version="latest"

RUN apk add --no-cache bash
WORKDIR /app
COPY --from=build-dev /src/todo-go /app/

EXPOSE 3001

ENTRYPOINT ["./todo-go"]
```

3. Use `docker build . -t todo-go-v2:latest` to build your backend application container

4. Load the docker image into the minikube environment using: `minikube image load todo-go-v2:latest`

#### Prepare you deployment

We use the [sidecar-deployment](sidecar-deployment/deployment.yaml).

Your deployment directory should contain the following files [see sidecar-deployment folder]
```
.
├── configmap.yaml
├── deployment.yaml
└── topaz-configmap.yaml
```

6. Apply the deployment on your minikube cluster use: `kubectl apply -f . --recursive`

Once the deployment is finished you will have a pod that will contain 2 running containers that use the following images:
```
ghcr.io/aserto-dev/topaz:latest 
todo-go-v2:latest
```

Get the running pod name:
```
TODO_POD_NAME=$(kubectl get pods -n default -l 'app=todo' -o jsonpath="{.items[0].metadata.name}")
```

### Testing the backend application 

If you want to test that the backend todo-go-v2 application is running from you local machine you can clone the [todo-application](https://github.com/aserto-demo/todo-application) but you will need to forwad the port from your minikube cluster to your local machine.

To forward the port of the todo-go-v2 backend deployment pod you will need to run:
```
kubectl --namespace default port-forward $TODO_POD_NAME 3001:3001
```

Navigate to the folder of the todo-application you have cloned and follow the instructions from the [README](https://github.com/aserto-demo/todo-application/blob/main/README.md)

## Deploy as a Microservice

The `topaz run` command will run the docker container in interactive mode. The following docker command can be used to run the container as a microservice.

```sh
#!/usr/bin/env bash

docker run \
-ti \
--rm \
--name topaz \
--platform=linux/amd64 \
-p 8282:8282 \
-p 8383:8383 \
-p 8484:8484 \
-p 9292:9292 \
-v $PWD/certs:/certs:rw \
-v $PWD/cfg:/app/cfg:ro \
-v $PWD/eds:/app/db:rw \
ghcr.io/aserto-dev/topaz:latest run \
--config-file /app/cfg/config.yaml
```

## Run as a binary

Topaz releases are available on [github](https://github.com/aserto-dev/topaz/releases/latest). The tarball contains both the `topaz` CLI (which can be used to create a configuration file), as well as `topazd` (which can be run as a daemon, and provides the authorizer APIs).

### Download the tarball

Downloads are available for Linux (amd64, arm64); MacOS (amd64, arm64); and Windows (zip, MSI).

For example, for Linux amd64:

```sh
curl -L https://github.com/aserto-dev/topaz/releases/download/v0.20.30/topaz_linux_x86_64.zip >topaz.zip
```

For Linux arm64:

```sh
curl -L https://github.com/aserto-dev/topaz/releases/download/v0.20.30/topaz_linux_arm64.zip >topaz.zip
```

### Unzip the tarball

```sh
unzip topaz_darwin_arm64.zip
Archive:  topaz_darwin_arm64.zip
  inflating: LICENSE
  inflating: README.md
  inflating: topazd
  inflating: topaz
```

### Run the configure command 

For example, to use the sample policy, you can run the following:

```sh
./topaz configure -d -s -r ghcr.io/aserto-policies/policy-todo-rebac:latest -n policy-todo
```

This will create a directory structure in `$HOME/.config/topaz` like this:

```sh
├──  certs
│   ├──  gateway-ca.crt
│   ├──  gateway.crt
│   ├──  gateway.key
│   ├──  grpc-ca.crt
│   ├──  grpc.crt
│   └──  grpc.key
├──  cfg
│   └──  config.yaml
└──  db
    └──  directory.db
```

### Run the topaz daemon

```sh
TOPAZ_DIR=$HOME/.config/topaz ./topazd run -c $HOME/.config/topaz/cfg/config.yaml
```
